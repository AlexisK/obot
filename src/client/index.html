<html>
<head>
  <style type="text/css">

  </style>
</head>
<body>
<div>
  <h1>CLinet</h1>
</div>
<script type="text/javascript">

  window.CONST = {
    slack_client_id : '10527566119.67577116550',
    domain          : 'http://alexey-stucco:3000/',
    team            : 'T0AFHGN3H',
    token           : localStorage.getItem('token')
  };

  function req(path, data) {
    return new Promise((resolve, reject) => {
      var oReq = new XMLHttpRequest();
      oReq.addEventListener("load", resolve);
      oReq.open("POST", `/${path}`);
      oReq.send(JSON.stringify({
        token : CONST.token,
        data
      }));
    });
  }

  function redirectToAuth() {
    location.replace(`https://slack.com/oauth/reflow?client_id=${CONST.slack_client_id}&scope=identity.basic&redirect_uri=${encodeURIComponent(CONST.domain + 'slack_auth/')}&team=${CONST.team}`);
  }

  function fetchAuth() {
    return new Promise((resolve, reject) => {
      if ( CONST.token ) {
        resolve(CONST.token);
      } else {
        redirectToAuth();
      }
    });
  }

  fetchAuth().then(token=> {
    req('users/list').then(users => {
      console.log(users);
    });
  });

</script>
</body>
</html>
